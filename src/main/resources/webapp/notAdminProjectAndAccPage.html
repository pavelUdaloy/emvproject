<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOT ADMIN</title>
</head>
<body>
<h2>NOT ADMIN</h2>
<p>ID: <span id="id"></span></p>
<p>Email: <span id="email"></span></p>
<p>Title: <span id="title"></span></p>
<p>First Name: <span id="firstName"></span></p>
<p>Last Name: <span id="lastName"></span></p>
<p>Project Name: <span id="projectName"></span></p>
<p>Project Id: <span id="projectId"></span></p>
<button id="logoutButton">Выход</button>

<h3>Мой проект</h3>
<table border="1">
    <thead>
    <tr>
        <th>Stage</th>
        <th>Status</th>
        <th>Description</th>
    </tr>
    </thead>
    <tbody id="projectInfoTable">
    <!-- Здесь будут отображены данные -->
    </tbody>
</table>

<h3>Комментарии</h3>
<div id="notesContainer">
    <!-- Здесь будут отображены комментарии -->
</div>

<script>
    window.addEventListener("load", async function() {
        const urlParams = new URLSearchParams(window.location.search);
        document.getElementById("id").innerText = urlParams.get("id");
        document.getElementById("email").innerText = urlParams.get("email");
        document.getElementById("title").innerText = urlParams.get("title");
        document.getElementById("firstName").innerText = urlParams.get("firstName");
        document.getElementById("lastName").innerText = urlParams.get("lastName");
        document.getElementById("projectName").innerText = urlParams.get("projectName");
        const projectId = urlParams.get("projectId");
        document.getElementById("projectId").innerText = projectId;

        // Выполнение GET запроса
        try {
            const response = await fetch(`http://localhost:8090/projects/${projectId}`);
            if (response.ok) {
                const projectData = await response.json();
                const tableBody = document.getElementById("projectInfoTable");

                // Преобразование данных в строки таблицы
                const createRow = (stage, status, description) => {
                    const row = document.createElement("tr");
                    const stageCell = document.createElement("td");
                    const statusCell = document.createElement("td");
                    const descriptionCell = document.createElement("td");

                    stageCell.innerText = stage;
                    statusCell.innerText = status ?? 'N/A';
                    descriptionCell.innerText = description;

                    row.appendChild(stageCell);
                    row.appendChild(statusCell);
                    row.appendChild(descriptionCell);

                    tableBody.appendChild(row);
                };

                createRow("Описание кода", projectData.correctCodeImplementationStatus, projectData.correctCodeImplementationDescription);
                createRow("Описание мобильного трекинга", projectData.correctMobileSiteTrackingStatus, projectData.correctMobileSiteTrackingDescription);
                createRow("Описание сингулярности кода", projectData.codeSingularityStatus, projectData.codeSingularityDescription);
                createRow("Описание одностраничного приложения", projectData.correctSinglePageApplicationTrackingStatus, projectData.correctSinglePageApplicationTrackingDescription);
                createRow("Описание конфигурации трекинга через домены", projectData.crossDomainTrackingConfigurationStatus, projectData.crossDomainTrackingConfigurationDescription);
                createRow("Описание саморефералов", projectData.selfReferralsStatus, projectData.selfReferralsDescription);
                createRow("Описание процесса рефералов оплаты", projectData.paymentProcessReferralsStatus, projectData.paymentProcessReferralsDescription);
                createRow("Описание UTM тегирования", projectData.utmTaggingStatus, projectData.utmTaggingDescription);
                createRow("Описание трекинга 404 ошибок", projectData.pages404ErrorTrackingStatus, projectData.pages404ErrorTrackingDescription);
                createRow("Описание нежелательных рефералов основного домена", projectData.mainDomainInListUnwantedReferralsStatus, projectData.mainDomainInListUnwantedReferralsDescription);
                createRow("Описание времени ожидания сессии", projectData.sessionTimeoutStatus, projectData.sessionTimeoutDescription);
                createRow("Описание окна обратного просмотра", projectData.lookbackWindowStatus, projectData.lookbackWindowDescription);
                createRow("Описание хранения данных пользователей и событий", projectData.userAndEventDataRetentionStatus, projectData.userAndEventDataRetentionDescription);
                createRow("Описание точности данных электронной коммерции", projectData.ecommerceDataAccuracyStatus, projectData.ecommerceDataAccuracyDescription);
                createRow("Описание трафика на ненастроенную целевую страницу", projectData.trafficToNotSetLandingPageStatus, projectData.trafficToNotSetLandingPageDescription);
                createRow("Описание валюты", projectData.currencyStatus, projectData.currencyDescription);
                createRow("Описание внутреннего трафика", projectData.defineInternalTrafficStatus, projectData.defineInternalTrafficDescription);
                createRow("Описание категории отрасли", projectData.industryCategoryStatus, projectData.industryCategoryDescription);
                createRow("Описание часового пояса отчетности", projectData.reportingTimeZoneStatus, projectData.reportingTimeZoneDescription);
                createRow("Описание трекинга событий", projectData.eventTrackingStatus, projectData.eventTrackingDescription);
                createRow("Описание трекинга конверсий", projectData.conversionTrackingStatus, projectData.conversionTrackingDescription);
                createRow("Описание стандартного трекинга покупок в электронной коммерции", projectData.standardPurchaseEcommerceTrackingImplementationStatus, projectData.standardPurchaseEcommerceTrackingImplementationDescription);
                createRow("Описание расширенного измерения", projectData.enhancedMeasurementStatus, projectData.enhancedMeasurementDescription);
                createRow("Описание трекинга идентификаторов пользователей", projectData.userIdTrackingImplementationStatus, projectData.userIdTrackingImplementationDescription);
                createRow("Описание улучшенного трекинга электронной коммерции", projectData.enhnancedEcommerceTrackingStatus, projectData.enhnancedEcommerceTrackingDescription);
                createRow("Описание трекинга пользовательских измерений и метрик", projectData.customDimensionsAndMetricsTrackingStatus, projectData.customDimensionsAndMetricsTrackingDescription);
                createRow("Описание сбора данных о местоположении и устройстве", projectData.granularLocationAndDeviceDataCollectionStatus, projectData.granularLocationAndDeviceDataCollectionDescription);
                createRow("Описание расширенных настроек для персонализации рекламы", projectData.advancedSettingsToAllowForAdsPersonalizationStatus, projectData.advancedSettingsToAllowForAdsPersonalizationDescription);
                createRow("Описание имени собственности", projectData.propertyNameStatus, projectData.propertyNameDescription);
                createRow("Описание имени потока", projectData.streamNameStatus, projectData.streamNameDescription);
                createRow("Описание таксономии трекинга событий", projectData.eventTrackingTaxonomyStatus, projectData.eventTrackingTaxonomyDescription);
                createRow("Описание связывания с Google BigQuery", projectData.googleBigqueryLinkingStatus, projectData.googleBigqueryLinkingDescription);
                createRow("Описание библиотеки", projectData.libraryStatus, projectData.libraryDescription);
                createRow("Описание связывания с Google Ads", projectData.googleAdsLinkingStatus, projectData.googleAdsLinkingDescription);
                createRow("Описание связывания с Google Search Console", projectData.googleSearchConsoleLinkingStatus, projectData.googleSearchConsoleLinkingDescription);
                createRow("Описание связывания с Google Merchant Center", projectData.googleMerchantCenterLinkingStatus, projectData.googleMerchantCenterLinkingDescription);
                createRow("Описание связывания с Display and Video 360", projectData.displayAndVideo360LinkingStatus, projectData.displayAndVideo360LinkingDescription);
                createRow("Описание импорта данных", projectData.dataImportStatus, projectData.dataImportDescription);
                createRow("Описание связывания с Ad Manager", projectData.adManagerLinkingStatus, projectData.adManagerLinkingDescription);
                createRow("Описание связывания с Search Ads 360", projectData.searchAds360LinkingStatus, projectData.searchAds360LinkingDescription);
                createRow("Описание сбора данных Google Signals", projectData.googleSignalsDataCollectionStatus, projectData.googleSignalsDataCollectionDescription);
                createRow("Описание модели атрибуции отчетов", projectData.reportingAttributionModelStatus, projectData.reportingAttributionModelDescription);
                createRow("Описание идентичности атрибуции отчетов", projectData.reportingAttributionIdentityStatus, projectData.reportingAttributionIdentityDescription);
                createRow("Описание реализации серверного трекинга", projectData.serverSideTrackingImplementationStatus, projectData.serverSideTrackingImplementationDescription);
                createRow("Описание режима согласия", projectData.consentModeStatus, projectData.consentModeDescription);
                createRow("Описание не сбора персональных данных", projectData.piiDataNotCollectionStatus, projectData.piiDataNotCollectionDescription);
            } else {
                alert("Ошибка получения данных проекта: " + response.status);
            }
        } catch (error) {
            console.error("Ошибка при выполнении запроса:", error);
            alert("Произошла ошибка при выполнении запроса. Проверьте консоль");
        }
        // Выполнение GET запроса для комментариев
        try {
            const notesResponse = await fetch(`http://localhost:8090/notes/${projectId}`);
            if (notesResponse.ok) {
                const notesData = await notesResponse.json();
                const notesContainer = document.getElementById("notesContainer");

                // Функция для создания элемента комментария с вложенностью
                const createNoteElement = (note, isNested = false) => {
                    const noteElement = document.createElement("div");
                    if (isNested) {
                        noteElement.style.marginLeft = "50px";
                    }
                    noteElement.innerHTML = `
                            <p><strong>${note.userEmail}</strong> (${new Date(note.sendedAt).toLocaleString()}):</p>
                            <p>${note.message}</p>
                        `;
                    if (note.notes && note.notes.length > 0) {
                        const nestedNotes = document.createElement("div");
                        note.notes.forEach(nestedNote => {
                            nestedNotes.appendChild(createNoteElement(nestedNote, true));
                        });
                        noteElement.appendChild(nestedNotes);
                    }
                    return noteElement;
                };

                notesData.forEach(note => {
                    notesContainer.appendChild(createNoteElement(note));
                });
            } else {
                alert("Ошибка получения комментариев: " + notesResponse.status);
            }
        } catch (error) {
            console.error("Ошибка при выполнении запроса:", error);
            alert("Произошла ошибка при выполнении запроса. Проверьте консоль для подробностей.");
        }
    });

    document.getElementById("logoutButton").addEventListener("click", function() {
        window.location.href = "login.html";
    });
</script>
</body>
</html>
